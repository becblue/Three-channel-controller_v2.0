# 项目名称
三通道切换箱控制系统

## 项目简介

这是一个三通道高压切换箱的主控制系统，该系统可以达到SIL3安全级别，双路冗余触发，双路状态反馈，状态OLED显示，系统内置看门狗，防止程序死机，外部电源异常监控，一路报警输出。三路内部设备温度监控，温度联动散热系统。并预留128M存储器、3路按键开关、RS485通讯端口（暂不开发此三部分功能）。

## 硬件配置（注意！！！以下配置已经再CUBEMX中完成，后续代码开发不需要重新配置）

MCU采用STM32F103RCT6  
外部8MHZ高速晶振
  OSC_IN -> OSC_IN
  OSC_OUT -> OSC_OUT

切换信号使能
 K1_EN -> PB9  下降沿使能，开启中断，优先级4
 K2_EN -> PB8  下降沿使能，开启中断，优先级4
 K3_EN -> PA15 下降沿使能，开启中断，优先级4

驱动继电器使能
K1_1_ON -> PC0  推挽输出,低电平使能，初始高电平，内部上拉，高速
K1_1_OFF -> PC1 推挽输出,低电平使能，初始高电平，内部上拉，高速
K2_1_ON -> PC2  推挽输出,低电平使能，初始高电平，内部上拉，高速
K2_1_OFF -> PC3 推挽输出,低电平使能，初始高电平，内部上拉，高速
K3_1_ON -> PC7  推挽输出,低电平使能，初始高电平，内部上拉，高速
K3_1_OFF -> PC6 推挽输出,低电平使能，初始高电平，内部上拉，高速
K1_2_ON -> PB12 推挽输出,低电平使能，初始高电平，内部上拉，高速
K1_2_OFF -> PA3 推挽输出,低电平使能，初始高电平，内部上拉，高速
K2_2_ON -> PA4  推挽输出,低电平使能，初始高电平，内部上拉，高速
K2_2_OFF -> PA5 推挽输出,低电平使能，初始高电平，内部上拉，高速
K3_2_ON -> PD2  推挽输出,低电平使能，初始高电平，内部上拉，高速
K3_2_OFF -> PA7 推挽输出,低电平使能，初始高电平，内部上拉，高速

驱动继电器状态反馈 
K1_1_STA -> PC4  输入，高电平有效，初始低电平，内部下拉，高速
K2_1_STA -> PC5  输入，高电平有效，初始低电平，内部下拉，高速
K3_1_STA -> PB0  输入，高电平有效，初始低电平，内部下拉，高速
K1_2_STA -> PB1  输入，高电平有效，初始低电平，内部下拉，高速
K2_2_STA -> PB10 输入，高电平有效，初始低电平，内部下拉，高速
K3_2_STA -> PB11 输入，高电平有效，初始低电平，内部下拉，高速

接触器状态反馈
SW1_STA -> PA8   输入，高电平有效，初始低电平，内部下拉，高速
SW2_STA -> PC9   输入，高电平有效，初始低电平，内部下拉，高速
SW3_STA -> PC8   输入，高电平有效，初始低电平，内部下拉，高速

外部电源监控
DC_CTRL -> PB5  上升沿使能，内部上拉，开启中断，优先级2

异常报警输出
ALARM -> PB4    推挽输出，低电平使能，初始高电平，内部上拉，高速

风扇控制
FAN_PWM -> PA6 使用TIM3的channel通道输出初始值为50%占空比的脉冲信号，Prescaler (PSC): 35// 预分频器 (72MHz/(35+1) = 2MHz)；Counter Period (ARR): 99// 自动重装载值  (2MHz/(99+1) = 20KHz)；Counter Mode: Up// 向上计数模式；Auto-reload preload: Enable  // 使能自动重装载预装载；Pulse: 50// 占空比50% (可根据需要调整)
FAN_SEN -> PC12 内置上拉，采用单位时间内检测到低电平脉冲数量方式计算出转速，计算公式：风扇转速(RPM) = (脉冲频率 × 60秒) ÷ 每转脉冲数，每一秒更新一次转速

报警蜂鸣器驱动
BEEP -> PB3    推挽输出，高电平有效，初始低电平，内部下拉，高速

NTC热敏电阻
NTC_1 -> PA0  ADC1_IN0,开启DMA通道并启用中断，优先级5，采样时间55.5.右对齐，连续扫描
NTC_2 -> PA1  ADC1_IN0,开启DMA通道并启用中断，优先级5，采样时间55.5.右对齐，连续扫描
NTC_3 -> PA2  ADC1_IN0,开启DMA通道并启用中断，优先级5，采样时间55.5.右对齐，连续扫描

OLED显示
采用I2C通讯
显示屏尺寸：2.42英寸
分辨率：128*64
控制芯片：SSD1309
显示颜色：白色
显示区域：55.01*27.49（mm）
工作电压：3.3V
参考规格书：见DOC文件夹中
             @2.42插接-ZJY242-2864ASWPG01.pdf
             @SSD1309.pdf
             @ZJY242I0400WG01.pdf
I2C1_SDA -> PB7 (连接到OLED显示屏SDA引脚)
I2C1_SCL -> PB6 (连接到OLED显示屏SCL引脚)

调试串口
USART3_TX -> PC10
USART3_RX -> PC11

RS485端口（暂不开发此功能）
USART1_TX -> PA9
USART1_RX -> PA10
RS485DE -> PA11  高电平发送，低电平接收，初始设置低电平，内置下拉电阻

外部存储存储器（暂不开发此功能）
采用SPI2接口，预分频系数16
参考规格书：见DOC文件夹中
             @W25Q128JVSIQ技术文档.pdf
SPI2_SCK -> PB13(连接到NOR FLASH CLK引脚)
SPI2_MISO -> PB14(连接到NOR FLASH DO引脚)
SPI2_MOSI -> PB15(连接到NOR FLASH DI引脚)

按键接口（暂不开发此功能）
KEY1 -> PC13  中断，下降沿使能，开启中断，优先级4
KEY2 -> PC14  中断，下降沿使能，开启中断，优先级4
KEY3 -> PC15  中断，下降沿使能，开启中断，优先级4


## 功能特性

主体工作流程：
系统上电后，OLED显示公司LOGO，维持2秒
开始进行时间为3秒的系统自检，OLED显示进度条
 自检内容：1、三路输入信号K1_EN、K2_EN、K3_EN均为高电平
          2、K1_1_STA、K1_2_STA、K2_1_STA、K2_2_STA、K3_1_STA、K3_2_STA、、SW1_STA、SW2_STA、SW3_STA均为低电平
          3、NTC温度均在60℃以下
自检结束后进入主循环。如自检异常，产生"O"异常标志

1 看门狗（IWDG）
预分频：64
重载值：1250
喂狗时间：1秒

2、继电器驱动逻辑
触发条件真值表：



使能开启第一通道：
当K1_EN检测到电平下降沿后开始间隔50ms连续检测三次均为低电平，则触发中断。
中断动作：
    开始判定：
           1、检测K2_EN、K3_EN是否为高电平，如果是，则进行下一步判定，如果否，产生则产生"A"异常标志。
           2、K2_1_STA、K2_2_STA、K3_1_STA、K3_2_STA、SW2_STA、SW3_STA是否为低电平，如果是则进行下一个判定，如果否，哪个信号为高电平，则产生相对应的异常标志。
    以上两次判定均为是，则K1_1_ON、K1_2_ON同时输出一个时长为500ms的低电平脉冲，用来驱动外部的磁保持继电器吸合。

    延时500ms后开始判定：
           1、K1_1_STA、K1_2_STA、SW1_STA是否为高电平，如果是，则OLED显示目前切换箱状态为打开（详情参阅OLED显示部分说明），如果否，则输出相对应异常标志

使能开启第二通道：
当K2_EN检测到电平下降沿后开始间隔50ms连续检测三次均为低电平，则触发中断。
中断动作：
    开始判定：
          1、检测K1_EN、K3_EN是否为高电平，如果是，则进行下一步判定，如果否，则产生"A"异常标志。
          2、K1_1_STA、K1_2_STA、K3_1_STA、K3_2_STA、SW1_STA、SW3_STA是否为低电平，如果是则进行下一个判定，如果否，哪个信号为高电平，则产生相对应的异常标志。
   以上两次判定均为是，则K2_1_ON、K2_2_ON同时输出一个时长为500ms的低电平脉冲，用来驱动外部的磁保持继电器吸合。

    延时500ms后开始判定：
          1、K2_1_STA、K2_2_STA、SW2_STA是否为高电平，如果是，则OLED显示目前切换箱状态为打开（详情参阅OLED显示部分说明），如果否，则输出相对应异常标志。

使能开启第三通道：
当K3_EN检测到电平下降沿后开始间隔50ms连续检测三次均为低电平，则触发中断。
中断动作：
     开始判定：
          1、检测K1_EN、K2_EN是否为高电平，如果是，则进行下一步判定，如果否，则产生"A"异常标志。
          2、K1_1_STA、K1_2_STA、K2_1_STA、K2_2_STA、SW1_STA、SW2_STA是否为低电平，如果是则进行下一个判定，如果否，哪个信号为高电平，则产生相对应的异常标志。
     以上两次判定均为是，则K3_1_ON、K3_2_ON同时输出一个时长为500ms的低电平脉冲，用来驱动外部的磁保持继电器吸合。
    延时500ms后开始判定：
          1、K3_1_STA、K3_2_STA、SW3_STA是否为高电平，如果是，则OLED显示目前切换箱状态为打开（详情参阅OLED显示部分说明），如果否，则输出相对应异常标志。

使能关闭第一通道
当K1_EN检测到电平上升沿后开始间隔50ms连续检测三次均为高电平，则触发中断。
中断动作：
    K1_1_OFF、K1_2_OFF同时输出一个时长为500ms的低电平脉冲，用来驱动外部的磁保持继电器断开后
    延时500ms后开始判定：
           1、K1_1_STA、K1_2_STA、SW1_STA是否为低电平，如果是，则OLED显示目前切换箱状态为关闭（详情参阅OLED显示部分说明），如果否，则输出相对应异常标志

使能关闭第二通道
当K2_EN检测到电平上升沿后开始间隔50ms连续检测三次均为高电平，则触发中断。
中断动作：
    K2_1_OFF、K2_2_OFF同时输出一个时长为500ms的低电平脉冲，用来驱动外部的磁保持继电器断开后
    延时500ms后开始判定：
           1、K2_1_STA、K2_2_STA、SW2_STA是否为低电平，如果是，则OLED显示目前切换箱状态为关闭（详情参阅OLED显示部分说明），如果否，则输出相对应异常标志

使能关闭第二通道
当K3_EN检测到电平上升沿后开始间隔50ms连续检测三次均为高电平，则触发中断。
中断动作：
    K3_1_OFF、K3_2_OFF同时输出一个时长为500ms的低电平脉冲，用来驱动外部的磁保持继电器断开后
    延时500ms后开始判定：
           1、K3_1_STA、K3_2_STA、SW3_STA是否为低电平，如果是，则OLED显示目前切换箱状态为关闭（详情参阅OLED显示部分说明），如果否，则输出相对应异常标志
           
3、温度检测逻辑
    硬件电路
采用3.3V供电。
使用一个10KΩ电阻与一个10K B值3435的NTC热敏电阻串联分压，分压点电压作为ADC采集信号。
NTC热敏电阻的RT值请参考@NTC热敏电阻RT值.csv文件。
采集与计算
轮流检测ADC1的IN0、IN1、IN2三个通道的电压值。
将测量到的电压值通过查表法对比RT值后，对应到当前对应的温度值。
风扇控制逻辑
如果温度小于35℃，判定为正常温度，风扇PWM占空比设置为50%。
如果温度大于等于35℃，判定为高温状态，风扇PWM占空比提高至95%。
如果温度大于等于60℃，在保持风扇PWM占空比95%的同时，产生异常标志K、L、M（分别对应NTC_1、NTC_2、NTC_3温度异常）。
温度下降到上一级别的阈值以下时，风扇控制和异常标志恢复到上一级别的状态，但需要设置2℃的温度回差（即避免频繁切换）。
异常标志
K：NTC_1温度异常
L：NTC_2温度异常
M：NTC_3温度异常

4、报警逻辑
当检测到任何标志的异常标志位，则将该异常输出到OLED屏幕上，同时使能"异常报警输出"和"报警蜂鸣器驱动"
异常报警输出：
  无论何种异常标志，ALARM -> PB4引脚均连续输出低电平
报警蜂鸣器驱动：
A类异常输出时间间隔位1秒的脉冲
B~J类异常输出时间间隔位50ms的脉冲
K~M类异常输出持续低电平

报警解除
A异常解除条件：发生A异常时，在报警同时，持续检测K1_EN、K2_EN、K3_EN三路的状态，确保只能有一路处于低电平或三路均处于高电平时，报警解除。
B~J异常解除条件：当发生此类异常时，需要持续检测K1_EN、K2_EN、K3_EN、K1_1_STA、K1_2_STA、K2_1_STA、K2_2_STA、K3_1_STA、K3_2_STA、、SW1_STA、SW2_STA、SW3_STA个点状态，确保符合三路触发后条件后（参考触发条件真值表），警报解除
K~M异常解除条件：当温度回降到58（考虑到回差）后报警解除。


异常标志：
    A - K1_EN、K2_EN、K3_EN使能冲突
    B - K1_1_STA工作异常
    C - K2_1_STA工作异常
    D - K3_1_STA工作异常
    E - K1_2_STA工作异常
    F - K2_2_STA工作异常
    G - K3_2_STA工作异常
    H - SW1_STA工作异常
    I - SW2_STA工作异常
    J - SW3_STA工作异常
    K - NTC_1温度异常
    L - NTC_2温度异常
    M - NTC_3温度异常
    O - 自检异常

5、OLED显示
OLED显示
上电开始先显示公司LOGO维持3秒后开始进入系统自检界面

系统自检界面显示自检信息，并显示进度条

自检结束后，进入待机界面

待机界面分三部分：以横线分割出每个区域
1、异常信息显示区域
2、三个通道的状态区域
3、温度显示以及风扇转速显示区域





## 目录结构



## 开发计划

## 开发环境

## 编译说明

## 注意事项

## 更新日志 